# ╔════════════════════════════════════════════════════════════════╗
# ║           LOGSTASH PIPELINE - TRAITEMENT DES LOGS              ║
# ║           Présenté par : Ines Tmimi - ENSIT                    ║
# ╚════════════════════════════════════════════════════════════════╝

# ─────────────────────────────────────────────────────────────────
# INPUT : D'où viennent les données ?
# ─────────────────────────────────────────────────────────────────
input {
  # Lecture des fichiers de logs de l'application
  file {
    path => "/var/log/application/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "application-logs"
  }

  # Réception via TCP (pour les logs envoyés en temps réel)
  tcp {
    port => 5000
    codec => json
    type => "tcp-logs"
  }
}

# ─────────────────────────────────────────────────────────────────
# FILTER : Comment transformer les données ?
# ─────────────────────────────────────────────────────────────────
filter {
  # Parser le timestamp
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss", "yyyy-MM-dd HH:mm:ss"]
    target => "@timestamp"
  }

  # Classifier la sévérité selon le niveau
  if [level] == "CRITICAL" {
    mutate {
      add_field => { "severity_score" => "4" }
      add_field => { "alert" => "true" }
      add_tag => ["critical_alert"]
    }
  } else if [level] == "ERROR" {
    mutate {
      add_field => { "severity_score" => "3" }
      add_field => { "alert" => "true" }
      add_tag => ["error_alert"]
    }
  } else if [level] == "WARNING" {
    mutate {
      add_field => { "severity_score" => "2" }
      add_field => { "alert" => "false" }
      add_tag => ["warning"]
    }
  } else {
    mutate {
      add_field => { "severity_score" => "1" }
      add_field => { "alert" => "false" }
    }
  }

  # Ajouter le nom de l'environnement
  mutate {
    add_field => { "environment" => "production" }
    add_field => { "processed_by" => "logstash" }
  }
}

# ─────────────────────────────────────────────────────────────────
# OUTPUT : Où envoyer les données ?
# ─────────────────────────────────────────────────────────────────
output {
  # Envoyer vers Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }

  # Afficher dans la console (pour debug)
  stdout {
    codec => rubydebug
  }
}